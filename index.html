<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DarePlay - The Ultimate Challenge</title>
    <!-- Razorpay Checkout Script -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- DAREPLAY APP STYLES --- */
        :root{--primary-color:#FF4848;--secondary-color:#FF8A00;--background-color:#121212;--surface-color:#1E1E1E;--text-color:#FFFFFF;--text-secondary-color:#A9A9A9}
        *{margin:0;padding:0;box-sizing:border-box}
        html, body { height: 100%; }
        body{font-family:'Poppins',sans-serif;background-color:var(--background-color);color:var(--text-color);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale; overflow-x: hidden;}
        .app-container{max-width:450px;margin:0 auto;background-color:var(--background-color);min-height:100vh;display:flex;flex-direction:column;position:relative;padding-bottom:70px}
        .app-header{display:flex;justify-content:space-between;align-items:center;padding:15px 20px;background-color:var(--surface-color);border-bottom:1px solid #333}
        .app-header h1{font-size:1.5em;font-weight:700;background:linear-gradient(90deg,var(--primary-color),var(--secondary-color));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .header-icons{display:flex;align-items:center}
        #header-user-name{font-weight:600;margin-right:10px}
        #header-profile-pic{width:35px;height:35px;border-radius:50%;border:2px solid var(--secondary-color);object-fit:cover}
        .content{flex-grow:1;overflow-y:auto;padding:20px}
        .page{display:none;animation:fadeIn .5s}@keyframes fadeIn{from{opacity:0}to{opacity:1}}.page.active{display:block}
        .btn{display:block;width:100%;padding:15px;border-radius:8px;border:none;font-size:1.1em;font-weight:600;cursor:pointer;text-align:center;transition:transform .2s, background .3s}.btn:active{transform:scale(.98)}
        .btn-primary{background:linear-gradient(90deg,var(--primary-color),var(--secondary-color));color:var(--text-color)}
        .btn:disabled{background:var(--text-secondary-color);cursor:not-allowed}
        #create-content{display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;min-height:calc(100vh - 200px)}
        #generated-dares-form{width:100%;margin-top:20px}
        .dare-block{background-color:var(--surface-color);border:1px solid #333;border-radius:8px;padding:15px;margin-bottom:15px;text-align:left}
        .dare-block p{margin:0 0 10px 0}
        .dare-block strong{color:var(--secondary-color)}
        .dare-block input{width:100%;background-color:#121212;border:1px solid #444;border-radius:5px;padding:10px;color:var(--text-color);font-size:1em}
        .loader{border:4px solid var(--surface-color);border-top:4px solid var(--primary-color);border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:20px auto}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
        .bottom-nav{position:fixed;bottom:0;left:0;right:0;max-width:450px;margin:0 auto;background-color:var(--surface-color);display:flex;justify-content:space-around;padding:10px 0;border-top:1px solid #333}
        .nav-item{display:flex;flex-direction:column;align-items:center;color:var(--text-secondary-color);cursor:pointer;border:none;background:none}.nav-item.active{color:var(--primary-color)}.nav-item .icon{font-size:1.6em}.nav-item .label{font-size:.7em}
        #user-info-modal{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,0.9);z-index:100;display:flex;align-items:center;justify-content:center}
        .modal-content{background-color:var(--surface-color);padding:25px;border-radius:12px;width:90%;max-width:400px;text-align:center}
        .modal-content h2{margin-bottom:20px}
        .form-group{margin-bottom:15px;text-align:left}
        .form-group label{display:block;margin-bottom:5px;font-size:0.9em;color:var(--text-secondary-color)}
        .form-group input{width:100%;background-color:#121212;border:1px solid #444;border-radius:8px;padding:12px;color:var(--text-color);font-size:1em}
        .dare-post{background-color:var(--surface-color);border-radius:12px;margin-bottom:20px;overflow:hidden;border:1px solid #282828}
        .dare-post-header{display:flex;align-items:center;padding:10px 15px}
        .dare-post-header img{width:40px;height:40px;border-radius:50%;margin-right:10px;border:2px solid var(--secondary-color);object-fit:cover}
        .dare-post-header .user-info{font-weight:600}
        .dare-post-header .user-info span{display:block;font-size:.8em;color:var(--text-secondary-color)}
        .custom-video-player{position:relative;background-color:#000;width:100%;padding-top:56.25%;overflow:hidden}
        .custom-video-player iframe{position:absolute;top:0;left:0;width:100%;height:100%;border:0}
        .dare-text-display{text-align:center;font-size:1.1em;font-weight:600;padding:15px;min-height:60px}
        .dare-post-actions{display:flex;justify-content:space-around;padding:15px;border-top:1px solid #282828}
        .action-button{display:flex;align-items:center;background:none;border:none;color:var(--text-secondary-color);font-size:1em;cursor:pointer}
        .hidden { display: none !important; }

        /* --- LUDO GAME STYLES (INTEGRATED) --- */
        #ludo-page-container {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #2c3e50 url('https://i.ibb.co/RT0g4Y1T/F8o-V6l-Y8-Qs-W-n-IRU84-Lb-Mg.webp') center/cover;
            padding: 10px;
        }
        #ludo-entry-screen { text-align: center; }
        #ludo-entry-screen h2 { margin-bottom: 20px; }
        .entry-buttons .btn { margin-bottom: 15px; }

        #player-selection-screen {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background-color: rgba(0, 0, 0, 0.7); padding: 40px; border-radius: 15px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }
        #player-selection-screen h2 { font-size: 2rem; color: #ffffff; margin-bottom: 25px; text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5); }
        #player-selection-screen .player-buttons { display: flex; flex-direction: column; gap: 20px; }
        #player-selection-screen .player-btn { padding: 15px 30px; font-size: 1.2rem; font-weight: bold; color: white; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; width: 200px; text-align: center; }
        #player-selection-screen .player-btn:hover { transform: translateY(-3px); box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        #btn-2-players { background-color: #3498db; }
        #btn-3-players { background-color: #2ecc71; }
        #btn-4-players { background-color: #e74c3c; }

        #ludo-game-container {
            width: 100%;
            max-width: 550px;
            margin: auto;
            max-height: 95vh;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
        }
        #top-bar {
            width: 100%; padding: 10px; background-color: rgba(0, 0, 0, 0.3);
            display: flex; justify-content: center; align-items: center;
            border-radius: 0 0 10px 10px; flex-shrink: 0; gap: 20px;
        }
        .top-btn {
            padding: 8px 16px; border: none; cursor: pointer; font-size: 16px; font-weight: bold;
            border-radius: 8px; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: transform 0.2s;
        }
        .top-btn:hover { transform: scale(1.05); }
        #back-btn { background-color: #3498db; }
        #reset-btn { background-color: #c0392b; }
        #game-timer { font-size: 1.5rem; color: white; font-weight: bold; }

        .ludo-container { width: 100%; position: relative; flex-grow: 1; display: flex; align-items: center; justify-content: center; margin-top: 20px; }
        .ludo {
            width: 100%; max-width: 100vw; padding-top: 100%;
            background-image: url('https://i.ibb.co/1YV4hMPd/ludo-bg.jpg');
            background-size: contain; background-repeat: no-repeat; background-position: center;
            position: relative; border: 3px solid #f1c40f; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5); border-radius: 10px;
        }
        .player-pieces, .player-bases { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .player-piece {
            width: 4.5%; height: 4.5%; border: 2px solid #000; border-radius: 50%;
            position: absolute; transform: translate(-50%, -50%); transition: all 0.2s linear; z-index: 10;
        }
        .player-piece.highlight { cursor: pointer; border: 3px solid #f1c40f; box-shadow: 0 0 15px 5px #f1c40f; animation: pulse 1s infinite ease-in-out; z-index: 20; }
        @keyframes pulse { 0% { transform: translate(-50%, -50%) scale(1); } 50% { transform: translate(-50%, -50%) scale(1.3); } 100% { transform: translate(-50%, -50%) scale(1); } }
        [player-id="P1"].player-piece { background-color: #e74c3c; } [player-id="P2"].player-piece { background-color: #3498db; }
        [player-id="P3"].player-piece { background-color: #f1c40f; } [player-id="P4"].player-piece { background-color: #2ecc71; }
        .player-base { width: 40%; height: 40%; position: absolute; border-radius: 5px; }
        .player-bases [player-id="P1"] { bottom: 0; right: 0; } .player-bases [player-id="P2"] { bottom: 0; left: 0; }
        .player-bases [player-id="P3"] { top: 0; left: 0; } .player-bases [player-id="P4"] { top: 0; right: 0; }
        .player-base.highlight { border: 4px dashed #f1c40f; animation: border-blink 0.7s infinite ease-in-out; }
        @keyframes border-blink { 50% { border-color: transparent; } }

        #bottom-bar {
            width: 100%; padding: 10px; background-color: rgba(0, 0, 0, 0.3);
            display: flex; justify-content: space-around; align-items: center;
            border-radius: 10px 10px 0 0; flex-shrink: 0; margin-top: auto;
        }
        .active-player { font-size: 1.5rem; font-weight: bold; color: #fff; text-shadow: 1px 1px 2px black; }
        #dice-container {
            cursor: pointer; transition: transform 0.2s; background-color: #fff;
            border: 2px solid #000; border-radius: 10px; padding: 5px; box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        #dice-container:not(.disabled):hover { transform: scale(1.1); }
        #dice-container.disabled { opacity: 0.5; cursor: not-allowed; pointer-events: none; animation: none; }
        #dice-container.glowing { animation: glow 1.5s infinite ease-in-out; }
        @keyframes glow { 0% { box-shadow: 0 0 2px #fff, 0 4px 6px rgba(0,0,0,0.2); } 50% { box-shadow: 0 0 15px #fff, 0 4px 6px rgba(0,0,0,0.2); } 100% { box-shadow: 0 0 2px #fff, 0 4px 6px rgba(0,0,0,0.2); } }
        #dice-svg rect { fill: white; stroke: black; }
        #dice-svg .dot { fill: black; transition: opacity 0.2s ease; opacity: 0; }
        #dice-svg .dot.visible { opacity: 1; }
        .dice-value { font-size: 3rem; font-weight: bold; color: #fff; text-shadow: 2px 2px 4px black; }
        .message-box {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.85); color: white; padding: 15px 25px;
            border-radius: 10px; z-index: 100; display: none; font-size: 1.5rem;
            box-shadow: 0 3px 15px rgba(0,0,0,0.5); text-align: center;
        }

        .players-2 .player-base[player-id="P2"], .players-2 .player-base[player-id="P4"],
        .players-2 .player-piece[player-id="P2"], .players-2 .player-piece[player-id="P4"] { display: none; }
        .players-3 .player-base[player-id="P2"], .players-3 .player-piece[player-id="P2"] { display: none; }
    </style>
</head>
<body>
    <!-- MODAL FOR USER INFO (NO CHANGE) -->
    <div id="user-info-modal">
        <div class="modal-content">
            <h2>Welcome to DarePlay</h2>
            <p style="color: var(--text-secondary-color); margin-bottom: 20px;">Please enter your details to continue.</p>
            <form id="user-info-form">
                <div class="form-group"><label for="user-name">Name</label><input type="text" id="user-name" required></div>
                <div class="form-group"><label for="user-email">Email</label><input type="email" id="user-email" required></div>
                <div class="form-group"><label for="user-mobile">Mobile No.</label><input type="tel" id="user-mobile" required></div>
                <div class="form-group"><label for="user-address">Address</label><input type="text" id="user-address" required></div>
                <div class="form-group"><label for="user-pic">Profile Pic URL</label><input type="url" id="user-pic" placeholder="https://example.com/image.jpg" required></div>
                <button type="submit" class="btn btn-primary" style="margin-top:10px;">Submit and Enter</button>
            </form>
        </div>
    </div>

    <!-- MAIN APP CONTAINER -->
    <div class="app-container" style="display: none;">
        <header class="app-header">
            <h1>DarePlay</h1>
            <div class="header-icons">
                <span id="header-user-name"></span>
                <img id="header-profile-pic" src="" alt="User">
            </div>
        </header>

        <main class="content">
            <!-- HOME PAGE (NO CHANGE) -->
            <section id="home" class="page active">
                <div id="dare-feed"><p style="text-align: center; color: var(--text-secondary-color);">Dare feed will appear here.</p></div>
            </section>
            
            <!-- CREATE PAGE (MODIFIED) -->
            <section id="create" class="page">
                <div id="create-content">
                    <!-- NEW: Options for Dare or Ludo -->
                    <div id="create-options">
                        <h2 style="margin-bottom: 20px;">Choose Your Challenge</h2>
                        <button id="show-dare-payment-btn" class="btn btn-primary">Get Dares (Pay ‚Çπ10)</button>
                        <button id="go-to-ludo-btn" class="btn btn-primary" style="margin-top: 15px; background: linear-gradient(90deg, #3498db, #2980b9);">Play Ludo Game</button>
                    </div>

                    <!-- Original Payment Container for Dares (Initially Hidden) -->
                    <div id="payment-container" style="display: none;">
                        <h2>Unlock Your Dares</h2>
                        <p>Pay to generate 5 unique and challenging dares.</p>
                        <button id="pay-btn" class="btn btn-primary" style="margin-top: 20px;" disabled>Loading Payment...</button>
                        <button id="back-to-create-options" class="btn" style="margin-top:10px; background-color: var(--text-secondary-color);">Back</button>
                    </div>

                    <div id="loader" class="loader" style="display: none;"></div>
                    <form id="generated-dares-form" style="display: none;"></form>
                </div>
            </section>

            <!-- NEW: LUDO GAME PAGE -->
            <section id="ludo" class="page">
                <div id="ludo-page-container">
                    <!-- Ludo Entry Fee Screen (Shows First) -->
                    <div id="ludo-entry-screen">
                        <h2>Select Entry Fee</h2>
                        <div class="entry-buttons">
                            <button class="btn btn-primary entry-fee-btn" data-amount="10">Play for ‚Çπ10</button>
                            <button class="btn btn-primary entry-fee-btn" data-amount="25">Play for ‚Çπ25</button>
                            <button class="btn btn-primary entry-fee-btn" data-amount="50">Play for ‚Çπ50</button>
                            <button class="btn btn-primary entry-fee-btn" data-amount="100">Play for ‚Çπ100</button>
                            <button class="btn btn-primary entry-fee-btn" data-amount="500">Play for ‚Çπ500</button>
                        </div>
                    </div>

                    <!-- Ludo Game Itself (Initially Hidden) -->
                    <div id="ludo-game-content" class="hidden">
                        <div id="player-selection-screen">
                            <h2>Select Number of Players</h2>
                            <div class="player-buttons">
                                <button class="player-btn" id="btn-2-players">2 Players</button>
                                <button class="player-btn" id="btn-3-players">3 Players</button>
                                <button class="player-btn" id="btn-4-players">4 Players</button>
                            </div>
                        </div>

                        <div id="ludo-game-container" class="hidden">
                            <div id="top-bar">
                                 <button class="top-btn" id="back-btn">Back</button>
                                 <div id="game-timer">10:00</div>
                                 <button class="top-btn" id="reset-btn">Reset</button>
                            </div>
                            <div class="message-box" id="message-box"></div>
                            <div class="ludo-container">
                                <div class="ludo">
                                    <div class="player-bases">
                                        <div class="player-base" player-id="P1"></div><div class="player-base" player-id="P2"></div>
                                        <div class="player-base" player-id="P3"></div><div class="player-base" player-id="P4"></div>
                                    </div>
                                    <div class="player-pieces">
                                        <div class="player-piece" player-id="P1" piece="0"></div><div class="player-piece" player-id="P1" piece="1"></div><div class="player-piece" player-id="P1" piece="2"></div><div class="player-piece" player-id="P1" piece="3"></div>
                                        <div class="player-piece" player-id="P2" piece="0"></div><div class="player-piece" player-id="P2" piece="1"></div><div class="player-piece" player-id="P2" piece="2"></div><div class="player-piece" player-id="P2" piece="3"></div>
                                        <div class="player-piece" player-id="P3" piece="0"></div><div class="player-piece" player-id="P3" piece="1"></div><div class="player-piece" player-id="P3" piece="2"></div><div class="player-piece" player-id="P3" piece="3"></div>
                                        <div class="player-piece" player-id="P4" piece="0"></div><div class="player-piece" player-id="P4" piece="1"></div><div class="player-piece" player-id="P4" piece="2"></div><div class="player-piece" player-id="P4" piece="3"></div>
                                    </div>
                                </div>
                            </div>
                            <div id="bottom-bar">
                                <h2 class="active-player">Player: <span></span></h2>
                                <div id="dice-container">
                                    <svg id="dice-svg" xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                        <circle id="dice-dot-1" class="dot" cx="8.5" cy="8.5" r="1.5"></circle><circle id="dice-dot-2" class="dot" cx="15.5" cy="15.5" r="1.5"></circle>
                                        <circle id="dice-dot-3" class="dot" cx="15.5" cy="8.5" r="1.5"></circle><circle id="dice-dot-4" class="dot" cx="8.5" cy="15.5" r="1.5"></circle>
                                        <circle id="dice-dot-5" class="dot" cx="12" cy="12" r="1.5"></circle><circle id="dice-dot-6" class="dot" cx="8.5" cy="12" r="1.5"></circle>
                                        <circle id="dice-dot-7" class="dot" cx="15.5" cy="12" r="1.5"></circle>
                                    </svg>
                                </div>
                                <div class="dice-value"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <section id="leaderboard" class="page"><h2>üèÜ Leaderboard</h2></section>
            <section id="profile" class="page"><h2>üë§ Profile</h2></section>
        </main>

        <nav class="bottom-nav">
            <button class="nav-item active" data-page="home"><span class="icon">üè†</span><span class="label">Home</span></button>
            <button class="nav-item" data-page="create"><span class="icon">‚ûï</span><span class="label">Create</span></button>
            <button class="nav-item" data-page="ludo"><span class="icon">üé≤</span><span class="label">Ludo</span></button>
            <button class="nav-item" data-page="leaderboard"><span class="icon">üèÜ</span><span class="label">Leaderboard</span></button>
            <button class="nav-item" data-page="profile"><span class="icon">üë§</span><span class="label">Profile</span></button>
        </nav>
    </div>

    <!-- Ludo Sound Files -->
    <audio id="dice-sound" src="https://www.soundjay.com/buttons/sounds/button-16.mp3" preload="auto"></audio>
    <audio id="move-sound" src="https://www.soundjay.com/buttons/sounds/button-7.mp3" preload="auto"></audio>
    <audio id="open-sound" src="https://www.soundjay.com/buttons/sounds/button-10.mp3" preload="auto"></audio>
    <audio id="kill-sound" src="https://www.soundjay.com/buttons/sounds/button-4.mp3" preload="auto"></audio>
    <audio id="home-sound" src="https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3" preload="auto"></audio>
    <audio id="win-sound" src="https://www.soundjay.com/misc/sounds/magic-chime-01.mp3" preload="auto"></audio>


    <script type="module">
        // --- FIREBASE INITIALIZATION ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, query, orderBy, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
        
        const firebaseConfig = {
          apiKey: "AIzaSyDuvWTMJL5edNG6cheez5pmwI2KlLCwtjw",
          authDomain: "shubhzone-4a6b0.firebaseapp.com",
          projectId: "shubhzone-4a6b0",
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- GLOBAL VARIABLES ---
        let razorpayKeyId;
        let currentUser = {};

        // --- INITIAL CHECKS ON PAGE LOAD ---
        // Check if user info is in localStorage to skip login modal
        (async () => {
            const savedUser = localStorage.getItem('darePlayUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                // Optional: Re-validate with Firestore
                const userDoc = await getDoc(doc(db, "users", currentUser.email));
                if (userDoc.exists()) {
                    displayUserInfoAndStartApp();
                } else {
                     document.getElementById('user-info-modal').style.display = 'flex';
                }
            } else {
                document.getElementById('user-info-modal').style.display = 'flex';
            }
        })();


        // --- DAREPLAY APP LOGIC ---

        function checkLocalStorageForDares() {
            const savedDares = localStorage.getItem('pendingDares');
            if (savedDares) {
                document.getElementById('create-options').style.display = 'none';
                document.getElementById('payment-container').style.display = 'none';
                displayDares(JSON.parse(savedDares));
            }
        }

        document.getElementById('user-info-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            currentUser = {
                name: document.getElementById('user-name').value,
                email: document.getElementById('user-email').value,
                mobile: document.getElementById('user-mobile').value,
                address: document.getElementById('user-address').value,
                picUrl: document.getElementById('user-pic').value
            };
            
            // Save user to Firestore and localStorage
            try {
                await setDoc(doc(db, "users", currentUser.email), currentUser);
                localStorage.setItem('darePlayUser', JSON.stringify(currentUser));
                displayUserInfoAndStartApp();
            } catch (error) {
                console.error("Error saving user data: ", error);
                alert("Could not save user data. Please try again.");
            }
        });

        function displayUserInfoAndStartApp() {
            document.getElementById('header-user-name').innerText = currentUser.name.split(' ')[0];
            document.getElementById('header-profile-pic').src = currentUser.picUrl;
            
            document.getElementById('user-info-modal').style.display = 'none';
            document.querySelector('.app-container').style.display = 'flex';
            
            initializeDarePaymentService();
            loadDareFeed();
            // Ludo game is initialized at the end of the script
        }
        
        async function initializeDarePaymentService() {
            const payBtn = document.getElementById('pay-btn');
            try {
                const response = await fetch('/api/get-key');
                if (!response.ok) throw new Error(`Server responded with an error: ${response.status}`);
                const data = await response.json();
                if (!data.keyId) throw new Error("Key ID was not received from the server.");
                razorpayKeyId = data.keyId;
                payBtn.disabled = false;
                payBtn.innerText = "Pay ‚Çπ10 and Generate Dares";
            } catch (error) {
                payBtn.innerText = "Payment Service Error";
                console.error(`Could not initialize payment service. Error: ${error.message}`);
            }
        }
        
        // --- NAVIGATION LOGIC ---
        window.showPage = (pageId) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            const navButton = document.querySelector(`.nav-item[data-page="${pageId}"]`);
            if (navButton) navButton.classList.add('active');

            if (pageId === 'create') {
                document.getElementById('create-options').style.display = 'block';
                document.getElementById('payment-container').style.display = 'none';
                document.getElementById('generated-dares-form').style.display = 'none';
                checkLocalStorageForDares();
            }
        };

        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', (e) => {
                const pageId = e.currentTarget.getAttribute('data-page');
                showPage(pageId);
            });
        });

        // --- "CREATE" PAGE BUTTONS LOGIC ---
        document.getElementById('show-dare-payment-btn').addEventListener('click', () => {
            document.getElementById('create-options').style.display = 'none';
            document.getElementById('payment-container').style.display = 'block';
        });

        document.getElementById('go-to-ludo-btn').addEventListener('click', () => {
            showPage('ludo');
        });

        document.getElementById('back-to-create-options').addEventListener('click', () => {
            document.getElementById('payment-container').style.display = 'none';
            document.getElementById('create-options').style.display = 'block';
        });


        // --- PAYMENT LOGIC (DARES & LUDO) ---
        async function startPayment(amount, description, onPaymentSuccess) {
            if (!razorpayKeyId) {
                await initializeDarePaymentService(); // Ensure key is loaded
            }
            if (!razorpayKeyId) return alert("Payment service is not available. Please refresh.");

            const loader = document.getElementById('loader');
            loader.style.display = 'block';

            try {
                const response = await fetch('/api/create-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount: amount, currency: "INR" }) // Pass amount to server
                });
                if (!response.ok) throw new Error("Server failed to create a payment order.");
                const order = await response.json();
                
                const options = {
                    key: razorpayKeyId,
                    amount: order.amount,
                    currency: order.currency,
                    name: "DarePlay",
                    description: description,
                    order_id: order.id,
                    handler: (paymentResponse) => onPaymentSuccess(paymentResponse),
                    prefill: { name: currentUser.name, email: currentUser.email, contact: currentUser.mobile },
                    theme: { color: "#FF4848" }
                };
                const rzp1 = new Razorpay(options);
                rzp1.on('payment.failed', (response) => {
                    alert("Payment Failed: " + response.error.description);
                    loader.style.display = 'none';
                });
                rzp1.open();
            } catch (error) {
                alert("Could not initiate payment: " + error.message);
                loader.style.display = 'none';
            }
        }

        // --- DARE-SPECIFIC PAYMENT ---
        document.getElementById('pay-btn').addEventListener('click', () => {
             startPayment(10, "Dare Generation Charge", verifyDarePaymentAndGenerateDares);
        });

        async function verifyDarePaymentAndGenerateDares(paymentResponse) {
            const loader = document.getElementById('loader');
            document.getElementById('payment-container').style.display = 'none';
            loader.style.display = 'block';
            try {
                const response = await fetch('/api/verify-payment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(paymentResponse)
                });
                const result = await response.json();
                if (result.error) throw new Error(result.error);
                
                localStorage.setItem('pendingDares', JSON.stringify(result.dares));
                displayDares(result.dares);
            } catch (error) {
                alert("Error after payment: " + error.message);
                loader.style.display = 'none';
                document.getElementById('payment-container').style.display = 'block';
            }
        }

        function displayDares(dares) {
            // (Existing dare display logic - no change needed here)
            const loader = document.getElementById('loader');
            loader.style.display = 'none';
            const form = document.getElementById('generated-dares-form');
            form.innerHTML = '';
            const dareTypes = ["Looks Easy, But Is Hard", "Helpful", "Fear-Facing", "Fear-Facing", "Fear-Facing"];
            dares.forEach((dare, index) => {
                form.innerHTML += `
                    <div class="dare-block">
                        <p><strong>${dareTypes[index]}:</strong> ${dare}</p>
                        <input type="url" name="youtubeLink${index}" placeholder="Paste proof video link for this dare" required>
                    </div>`;
            });
            form.innerHTML += `<button type="submit" class="btn btn-primary" style="margin-top:10px;">üöÄ Publish All Proofs</button>`;
            form.style.display = 'block';
        }

        // --- DARE SUBMISSION LOGIC (NO CHANGE) ---
        document.getElementById('generated-dares-form').addEventListener('submit', async function(e) { e.preventDefault(); /* ... existing code ... */ });

        // --- DARE FEED LOGIC (NO CHANGE) ---
        function loadDareFeed() { /* ... existing code ... */ }
        function createDarePostHTML(id, post) { /* ... existing code ... */ }
        function extractYouTubeID(url) { /* ... existing code ... */ }


        // =============================================================
        // LUDO GAME LOGIC (INTEGRATED)
        // =============================================================

        // --- LUDO PAYMENT & START LOGIC ---
        document.querySelectorAll('.entry-fee-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const amount = parseInt(e.currentTarget.dataset.amount, 10);
                
                // Special user check
                if (currentUser.name.toLowerCase() === "himanshu maurya" && currentUser.email.toLowerCase() === "udbhavscience12@gmail.com") {
                    alert("Welcome, Himanshu! Starting game for free.");
                    startLudoGame();
                    return;
                }

                // Proceed with payment for other users
                const description = `Ludo Game Entry Fee`;
                startPayment(amount, description, (paymentResponse) => {
                    // On successful Ludo payment
                    console.log("Ludo payment successful:", paymentResponse);
                    document.getElementById('loader').style.display = 'none';
                    alert("Payment successful! Let's play.");
                    startLudoGame();
                });
            });
        });
        
        function startLudoGame() {
            document.getElementById('ludo-entry-screen').classList.add('hidden');
            document.getElementById('ludo-game-content').classList.remove('hidden');
            // This now shows the player selection screen, the ludo game flow will handle the rest.
        }

        // --- LUDO GAME CONSTANTS AND CLASSES ---
        const COORDINATES_MAP = { 0: [1.5, 6.5], 1: [2.5, 6.5], 2: [3.5, 6.5], 3: [4.5, 6.5], 4: [5.5, 6.5], 5: [6.5, 5.5], 6: [6.5, 4.5], 7: [6.5, 3.5], 8: [6.5, 2.5], 9: [6.5, 1.5], 10: [6.5, 0.5], 11: [7.5, 0.5], 12: [8.5, 0.5], 13: [8.5, 1.5], 14: [8.5, 2.5], 15: [8.5, 3.5], 16: [8.5, 4.5], 17: [8.5, 5.5], 18: [9.5, 6.5], 19: [10.5, 6.5], 20: [11.5, 6.5], 21: [12.5, 6.5], 22: [13.5, 6.5], 23: [14.5, 6.5], 24: [14.5, 7.5], 25: [14.5, 8.5], 26: [13.5, 8.5], 27: [12.5, 8.5], 28: [11.5, 8.5], 29: [10.5, 8.5], 30: [9.5, 8.5], 31: [8.5, 9.5], 32: [8.5, 10.5], 33: [8.5, 11.5], 34: [8.5, 12.5], 35: [8.5, 13.5], 36: [8.5, 14.5], 37: [7.5, 14.5], 38: [6.5, 14.5], 39: [6.5, 13.5], 40: [6.5, 12.5], 41: [6.5, 11.5], 42: [6.5, 10.5], 43: [6.5, 9.5], 44: [5.5, 8.5], 45: [4.5, 8.5], 46: [3.5, 8.5], 47: [2.5, 8.5], 48: [1.5, 8.5], 49: [0.5, 8.5], 50: [0.5, 7.5], 51: [0.5, 6.5], 100: [1.5, 7.5], 101: [2.5, 7.5], 102: [3.5, 7.5], 103: [4.5, 7.5], 104: [5.5, 7.5], 105: [6.5, 7.5], 200: [7.5, 1.5], 201: [7.5, 2.5], 202: [7.5, 3.5], 203: [7.5, 4.5], 204: [7.5, 5.5], 205: [7.5, 6.5], 300: [13.5, 7.5], 301: [12.5, 7.5], 302: [11.5, 7.5], 303: [10.5, 7.5], 304: [9.5, 7.5], 305: [8.5, 7.5], 400: [7.5, 13.5], 401: [7.5, 12.5], 402: [7.5, 11.5], 403: [7.5, 10.5], 404: [7.5, 9.5], 405: [7.5, 8.5], 500: [2, 2], 501: [4, 2], 502: [2, 4], 503: [4, 4], 600: [11, 2], 601: [13, 2], 602: [11, 4], 603: [13, 4], 700: [11, 11], 701: [13, 11], 702: [11, 13], 703: [13, 13], 800: [2, 11], 801: [4, 11], 802: [2, 13], 803: [4, 13], };
        const STEP_LENGTH = 100 / 15;
        const PLAYERS_CONFIG = { 'P1': { id: 'P1', name: 'Red',    base: [700, 701, 702, 703], start: 26, turn_point: 25, home_entrance: [300, 301, 302, 303, 304, 305], home: 305 }, 'P2': { id: 'P2', name: 'Blue',   base: [800, 801, 802, 803], start: 39, turn_point: 38, home_entrance: [400, 401, 402, 403, 404, 405], home: 405 }, 'P3': { id: 'P3', name: 'Yellow', base: [500, 501, 502, 503], start: 1,  turn_point: 51, home_entrance: [100, 101, 102, 103, 104, 105], home: 105 }, 'P4': { id: 'P4', name: 'Green',  base: [600, 601, 602, 603], start: 13, turn_point: 12, home_entrance: [200, 201, 202, 203, 204, 205], home: 205 }, };
        const SAFE_POSITIONS = [1, 9, 13, 22, 26, 34, 39, 47];
        const STATE = { DICE_NOT_ROLLED: 'DICE_NOT_ROLLED', DICE_ROLLING: 'DICE_ROLLING', DICE_ROLLED: 'DICE_ROLLED', GAME_OVER: 'GAME_OVER' };

        class LudoUI {
            // (The entire Ludo UI class from your file)
             static playerPiecesElements = { P1: document.querySelectorAll('[player-id="P1"].player-piece'), P2: document.querySelectorAll('[player-id="P2"].player-piece'), P3: document.querySelectorAll('[player-id="P3"].player-piece'), P4: document.querySelectorAll('[player-id="P4"].player-piece'), };
            static diceContainerElement = document.querySelector('#dice-container');
            static resetButtonElement = document.querySelector('#reset-btn');
            static backButtonElement = document.querySelector('#back-btn');
            static messageBoxElement = document.querySelector('#message-box');
            static playerSelectionScreen = document.getElementById('player-selection-screen');
            static gameContainer = document.getElementById('ludo-game-container');
            static diceDots = [ document.getElementById('dice-dot-1'), document.getElementById('dice-dot-2'), document.getElementById('dice-dot-3'), document.getElementById('dice-dot-4'), document.getElementById('dice-dot-5'), document.getElementById('dice-dot-6'), document.getElementById('dice-dot-7') ];
            static dicePatterns = { 1: [4], 2: [0, 1], 3: [0, 4, 1], 4: [0, 1, 2, 3], 5: [0, 1, 2, 3, 4], 6: [0, 1, 2, 3, 5, 6] };
            static listenDiceClick(cb) { this.diceContainerElement.addEventListener('click', cb); }
            static listenResetClick(cb) { this.resetButtonElement.addEventListener('click', cb); }
            static listenBackClick(cb) { this.backButtonElement.addEventListener('click', cb); }
            static listenPieceClick(cb) { document.querySelector('.player-pieces').addEventListener('click', cb); }
            static listenPlayerSelection(cb) { document.getElementById('btn-2-players').addEventListener('click', () => cb(2)); document.getElementById('btn-3-players').addEventListener('click', () => cb(3)); document.getElementById('btn-4-players').addEventListener('click', () => cb(4)); }
            static showGameScreen(numPlayers) { this.playerSelectionScreen.classList.add('hidden'); this.gameContainer.classList.remove('hidden'); document.getElementById('ludo-page-container').className = `players-${numPlayers}`; }
            static showPlayerSelectionScreen() { this.playerSelectionScreen.classList.remove('hidden'); this.gameContainer.classList.add('hidden'); document.getElementById('ludo-page-container').className = ''; }
            static setPiecePosition(player, piece, pos) { if (!this.playerPiecesElements[player]?.[piece]) return; const [x, y] = COORDINATES_MAP[pos]; this.playerPiecesElements[player][piece].style.top = `${y * STEP_LENGTH}%`; this.playerPiecesElements[player][piece].style.left = `${x * STEP_LENGTH}%`; }
            static setTurn(playerId) { const playerConfig = PLAYERS_CONFIG[playerId]; document.querySelector('.active-player span').innerText = `${playerConfig.name}`; document.querySelectorAll('.player-base.highlight').forEach(b => b.classList.remove('highlight')); document.querySelector(`.player-base[player-id="${playerId}"]`).classList.add('highlight'); }
            static enableDice() { this.diceContainerElement.classList.remove('disabled'); this.diceContainerElement.classList.add('glowing'); }
            static disableDice() { this.diceContainerElement.classList.add('disabled'); this.diceContainerElement.classList.remove('glowing'); }
            static highlightPieces(player, pieces) { pieces.forEach(p => this.playerPiecesElements[player][p].classList.add('highlight')); }
            static unhighlightPieces() { document.querySelectorAll('.player-piece.highlight').forEach(el => el.classList.remove('highlight')); }
            static setDiceValue(val) { document.querySelector('.dice-value').innerText = val || ''; }
            static updateDiceFace(value) { this.diceDots.forEach(dot => dot.classList.remove('visible')); if (this.dicePatterns[value]) { this.dicePatterns[value].forEach(dotIndex => { this.diceDots[dotIndex].classList.add('visible'); }); } }
            static showMessage(message, duration = 2000) { this.messageBoxElement.innerText = message; this.messageBoxElement.style.display = 'block'; setTimeout(() => { this.messageBoxElement.style.display = 'none'; }, duration); }
            static playSound(soundId) { const sound = document.getElementById(soundId); if (sound) { sound.currentTime = 0; sound.play().catch(error => console.log(`Sound play failed for ${soundId}: ${error.message}`)); } }
        }

        class LudoGame {
            // (The entire Ludo class from your file, renamed to LudoGame to avoid conflicts)
            currentPositions = {}; _diceValue; _turnIndex; _state; activePlayers = []; sixStreak = 0;
            get diceValue() { return this._diceValue; }
            set diceValue(v) { this._diceValue = v; LudoUI.setDiceValue(v); LudoUI.updateDiceFace(v); }
            get turn() { return this.activePlayers[this._turnIndex]; }
            set turn(playerId) { this._turnIndex = this.activePlayers.indexOf(playerId); if(this._turnIndex === -1) { this._turnIndex = 0; } LudoUI.setTurn(this.activePlayers[this._turnIndex]); }
            get state() { return this._state; }
            set state(v) { this._state = v; if (v === STATE.DICE_NOT_ROLLED) { LudoUI.enableDice(); } else { LudoUI.disableDice(); } if (v === STATE.GAME_OVER) { LudoUI.disableDice(); } }
            constructor() { this.listenSetup(); this.listenGameActions(); }
            listenSetup() { LudoUI.listenPlayerSelection(this.initializeGame.bind(this)); }
            listenGameActions() { LudoUI.listenDiceClick(this.onDiceClick.bind(this)); LudoUI.listenResetClick(() => { this.resetGame(true); }); LudoUI.listenBackClick(this.startNewGame.bind(this)); LudoUI.listenPieceClick(this.onPieceClick.bind(this)); }
            initializeGame(numPlayers) {
                // Here you can add logic to add an AI player if numPlayers < 2
                if (numPlayers === 1) {
                    alert("Starting game with an AI player.");
                    // this.activePlayers = ['P1', 'AI_P3']; // Example AI logic
                } else if (numPlayers === 2) { this.activePlayers = ['P1', 'P3']; }
                else if (numPlayers === 3) { this.activePlayers = ['P1', 'P3', 'P4']; }
                else { this.activePlayers = ['P1', 'P2', 'P3', 'P4']; }
                LudoUI.showGameScreen(numPlayers); this.resetGame();
            }
            startNewGame() { LudoUI.showPlayerSelectionScreen(); }
            resetGame(fromButton = false) { this.currentPositions = {}; this.activePlayers.forEach(player => { this.currentPositions[player] = [...PLAYERS_CONFIG[player].base]; }); Object.keys(PLAYERS_CONFIG).forEach(playerId => { const playerConfig = PLAYERS_CONFIG[playerId]; for (let piece = 0; piece < 4; piece++) { const pos = this.activePlayers.includes(playerId) ? this.currentPositions[playerId][piece] : playerConfig.base[piece]; LudoUI.setPiecePosition(playerId, piece, pos); } }); this._turnIndex = 0; this.turn = this.activePlayers[this._turnIndex]; this.state = STATE.DICE_NOT_ROLLED; this.diceValue = null; this.sixStreak = 0; LudoUI.unhighlightPieces(); if(fromButton) { LudoUI.showMessage("Game Reset!", 2000); } }
            onDiceClick() { if (this.state !== STATE.DICE_NOT_ROLLED) return; this.state = STATE.DICE_ROLLING; LudoUI.disableDice(); let rollCount = 0; const rollAnimation = setInterval(() => { rollCount++; LudoUI.updateDiceFace(1 + Math.floor(Math.random() * 6)); if (rollCount > 10) { clearInterval(rollAnimation); LudoUI.playSound('dice-sound'); this.diceValue = 1 + Math.floor(Math.random() * 6); if (this.diceValue === 6) { this.sixStreak++; } else { this.sixStreak = 0; } if (this.sixStreak === 3) { LudoUI.showMessage("Three 6s! Turn forfeited.", 2000); setTimeout(() => this.incrementTurn(true), 2000); return; } this.state = STATE.DICE_ROLLED; this.checkForEligiblePieces(); } }, 80); }
            incrementTurn(force = false) { this._turnIndex = (this._turnIndex + 1) % this.activePlayers.length; this.turn = this.activePlayers[this._turnIndex]; this.state = STATE.DICE_NOT_ROLLED; this.diceValue = null; if (force) { this.sixStreak = 0; } LudoUI.unhighlightPieces(); LudoUI.showMessage(`${PLAYERS_CONFIG[this.turn].name}'s Turn`, 1500); }
            checkForEligiblePieces() { const eligiblePieces = this.getEligiblePieces(this.turn); if (eligiblePieces.length > 0) { LudoUI.highlightPieces(this.turn, eligiblePieces); } else { LudoUI.showMessage("No possible moves!", 1500); if (this.diceValue !== 6) { setTimeout(() => this.incrementTurn(), 1500); } else { this.state = STATE.DICE_NOT_ROLLED; } } }
            getEligiblePieces(player) { const playerConfig = PLAYERS_CONFIG[player]; return [0, 1, 2, 3].filter(piece => { const currentPos = this.currentPositions[player][piece]; if (currentPos === playerConfig.home) return false; const isAtBase = playerConfig.base.includes(currentPos); if (isAtBase && this.diceValue !== 6) return false; const destination = this.getFinalDestination(player, piece, this.diceValue); if (destination === null) return false; if (isAtBase) { return true; } const ownPiecesAtDestination = this.currentPositions[player].filter((p, i) => i !== piece && p === destination); return ownPiecesAtDestination.length === 0; }); }
            getFinalDestination(player, piece, moveBy) { let position = this.currentPositions[player][piece]; const playerConfig = PLAYERS_CONFIG[player]; if (playerConfig.base.includes(position)) { return playerConfig.start; } for (let i = 0; i < moveBy; i++) { const homePathIndex = playerConfig.home_entrance.indexOf(position); if (homePathIndex !== -1) { if (homePathIndex + 1 >= playerConfig.home_entrance.length) return null; position = playerConfig.home_entrance[homePathIndex + 1]; } else if (position === playerConfig.turn_point) { position = playerConfig.home_entrance[0]; } else { position = (position + 1) % 52; } } return position; }
            onPieceClick(event) { const target = event.target; if (this.state !== STATE.DICE_ROLLED || !target.classList.contains('player-piece') || !target.classList.contains('highlight')) return; const player = target.getAttribute('player-id'); const piece = parseInt(target.getAttribute('piece')); if (player !== this.turn) return; this.handlePieceClick(player, piece); }
            handlePieceClick(player, piece) { LudoUI.unhighlightPieces(); const playerConfig = PLAYERS_CONFIG[player]; const currentPosition = this.currentPositions[player][piece]; if (playerConfig.base.includes(currentPosition) && this.diceValue === 6) { this.currentPositions[player][piece] = playerConfig.start; LudoUI.setPiecePosition(player, piece, playerConfig.start); LudoUI.playSound('open-sound'); LudoUI.showMessage("Piece is out! Roll again.", 1500); this.checkForKill(player, piece); this.state = STATE.DICE_NOT_ROLLED; return; } this.movePiece(player, piece, this.diceValue); }
            movePiece(player, piece, moveBy) { const finalDestination = this.getFinalDestination(player, piece, moveBy); this.currentPositions[player][piece] = finalDestination; LudoUI.setPiecePosition(player, piece, finalDestination); LudoUI.playSound('move-sound'); this.afterMoveChecks(player, piece); }
            afterMoveChecks(player, piece) { const finalPosition = this.currentPositions[player][piece]; const playerConfig = PLAYERS_CONFIG[player]; const isKill = this.checkForKill(player, piece); if (this.hasPlayerWon(player)) { LudoUI.playSound('win-sound'); LudoUI.showMessage(`${playerConfig.name} has won!`, 5000); this.state = STATE.GAME_OVER; return; } const isHome = finalPosition === playerConfig.home; if(isHome) { LudoUI.playSound('home-sound'); LudoUI.showMessage("Piece is home! Roll again.", 2000); } if (isKill || this.diceValue === 6 || isHome) { this.state = STATE.DICE_NOT_ROLLED; } else { this.incrementTurn(); } }
            checkForKill(player, piece) { const currentPosition = this.currentPositions[player][piece]; if (SAFE_POSITIONS.includes(currentPosition)) return false; let kill = false; this.activePlayers.forEach(opponent => { if (opponent === player) return; const opponentConfig = PLAYERS_CONFIG[opponent]; if (this.currentPositions[opponent]) { this.currentPositions[opponent].forEach((opponentPos, opponentPiece) => { if (opponentPos === currentPosition && !opponentConfig.base.includes(opponentPos)) { this.currentPositions[opponent][opponentPiece] = opponentConfig.base[opponentPiece]; LudoUI.setPiecePosition(opponent, opponentPiece, opponentConfig.base[opponentPiece]); kill = true; LudoUI.playSound('kill-sound'); LudoUI.showMessage("Knocked a piece out! Roll again.", 2000); } }); } }); return kill; }
            hasPlayerWon(player) { const playerConfig = PLAYERS_CONFIG[player]; return this.currentPositions[player].every(p => p === playerConfig.home); }
        }

        // --- INITIALIZE THE LUDO GAME OBJECT ---
        new LudoGame();

        // --- INITIALIZE WITH HOME PAGE ---
        showPage('home');
    </script>
</body>
</html>
