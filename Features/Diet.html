<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Health Assistant</title>
    <!-- Google Fonts: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Icon Library: Boxicons -->
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

    <style>
        :root {
            --primary-color: #00A9B5; --secondary-color: #088F8F; --accent-color: #34D1BF;
            --avoid-color: #FF3B30; --limit-color: #FF9500; --safe-color: #34C759;
            --background-color: #F0FAFA; --card-bg-color: #ffffff; --text-color: #1c1c1e;
            --text-light-color: #8A8A8E; --font-family: 'Poppins', sans-serif;
            --box-shadow-3d: 0 8px 16px rgba(0, 0, 0, 0.15); --border-radius: 16px;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideInUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        body { margin: 0; padding: 0; font-family: var(--font-family); background-color: var(--background-color); color: var(--text-color); padding-bottom: 80px; }
        .main-container { padding: 20px; }
        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.4s ease-in-out; }
        .btn-3d { padding: 15px 25px; font-size: 16px; font-weight: 600; color: white; border: none; border-radius: 12px; cursor: pointer; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2); box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.4), 0 6px 12px rgba(0, 0, 0, 0.2); transition: transform 0.1s, box-shadow 0.1s; }
        .btn-3d:active { transform: translateY(2px); box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.4), 0 4px 8px rgba(0, 0, 0, 0.25); }
        .btn-3d:disabled { background-color: #ccc !important; background-image: none !important; cursor: not-allowed; box-shadow: none; }
        .input-container { display: flex; gap: 10px; align-items: center; margin-bottom: 20px; }
        .input-container input { flex-grow: 1; padding: 15px; font-size: 16px; border: 1px solid #ccc; border-radius: 12px; min-width: 0; }
        #add-med-btn, #add-disease-btn { flex-shrink: 0; background: linear-gradient(45deg, var(--accent-color), var(--primary-color)); }
        #generate-btn { width: 100%; padding: 20px; font-size: 18px; background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)); }
        #medicine-tags-container { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 25px; min-height: 50px; }
        .medicine-tag { background-color: #e0f7fa; color: var(--secondary-color); padding: 10px 15px; border-radius: 8px; font-weight: 500; display: flex; align-items: center; gap: 8px; position: relative; padding-right: 30px; }
        .remove-tag { position: absolute; top: 2px; right: 5px; cursor: pointer; font-size: 20px; color: var(--secondary-color); }
        #results-container { margin-top: 30px; }
        .swipe-indicator { text-align: center; color: var(--text-light-color); margin-bottom: 15px; font-weight: 500; }
        .results-scroller { display: flex; gap: 20px; overflow-x: auto; padding: 10px; scroll-snap-type: x mandatory; scrollbar-width: none; }
        .results-scroller::-webkit-scrollbar { display: none; }
        .result-card { flex: 0 0 85%; background-color: var(--card-bg-color); border-radius: var(--border-radius); padding: 20px; box-shadow: var(--box-shadow-3d); border-top: 10px solid; scroll-snap-align: start; display: flex; flex-direction: column; }
        .result-card-header { text-align: center; margin-bottom: 15px; }
        .result-card-header .sticker { font-size: 48px; }
        .result-card-header h3 { margin: 10px 0 0; font-size: 22px; }
        .result-card-content ul { list-style-type: none; padding-left: 0; margin:0; }
        .result-card-content li { padding: 10px; border-bottom: 1px solid #eee; font-size: 16px; }
        .result-card-content li:last-child { border-bottom: none; }
        .card-avoid { border-color: var(--avoid-color); } .card-avoid h3, .card-avoid li { color: var(--avoid-color); }
        .card-limit { border-color: var(--limit-color); } .card-limit h3, .card-limit li { color: var(--limit-color); }
        .card-safe { border-color: var(--safe-color); } .card-safe h3, .card-safe li { color: var(--safe-color); }
        .card-cure { border-color: var(--primary-color); } .card-cure h3, .card-cure p { color: var(--secondary-color); }
        #my-plan-empty-state { text-align: center; padding: 40px 20px; }
        #my-plan-empty-state i { font-size: 80px; color: var(--accent-color); }
        #my-plan-empty-state h2 { font-size: 22px; color: var(--secondary-color); margin-top: 20px; }
        #my-plan-empty-state p { color: var(--text-light-color); margin-bottom: 30px; }
        #create-my-plan-btn { background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)); width: 80%; }
        #my-plan-generated-state { display: none; }
        .date-navigator { display: flex; justify-content: space-between; align-items: center; padding: 10px; background-color: var(--card-bg-color); border-radius: var(--border-radius); margin-bottom: 25px; }
        .date-navigator i { font-size: 28px; color: var(--primary-color); cursor: pointer; }
        .date-navigator h2 { margin: 0; font-size: 18px; color: var(--secondary-color); font-weight: 600; text-align: center; }
        #today-btn { font-size: 14px; font-weight: 600; color: var(--primary-color); cursor: pointer; background: #e0f7fa; padding: 8px 12px; border-radius: 8px;}
        .timeline-container { position: relative; }
        .timeline-container::before { content: ''; position: absolute; left: 43px; top: 10px; bottom: 10px; width: 3px; background-color: #e0f7fa; border-radius: 2px; }
        .alert-card { display: flex; align-items: flex-start; gap: 15px; margin-bottom: 20px; position: relative; }
        .alert-time { flex: 0 0 65px; font-weight: 600; color: var(--text-light-color); margin-top: 12px; text-align: right; font-size: 14px; }
        .alert-timeline-marker { flex-shrink: 0; z-index: 1; }
        .alert-icon { font-size: 24px; color: white; background-color: var(--primary-color); border-radius: 50%; width: 50px; height: 50px; display: flex; justify-content: center; align-items: center; border: 4px solid var(--background-color); }
        .alert-content { background-color: var(--card-bg-color); border-radius: var(--border-radius); padding: 15px; flex-grow: 1; box-shadow: 0 4px 12px rgba(0,0,0,0.05); cursor: pointer; }
        .alert-content h3 { margin: 0 0 5px; font-size: 18px; }
        .alert-content p { margin: 0; font-size: 14px; color: var(--text-light-color); }
        #alert-empty-state { text-align: center; padding: 50px 20px; }
        #alert-empty-state i { font-size: 80px; color: var(--accent-color); }
        #alert-empty-state h2 { color: var(--secondary-color); margin-top: 20px; }
        #alert-empty-state p { color: var(--text-light-color); }
        .learn-search-container { display: flex; gap: 10px; margin-bottom: 25px; }
        #learn-search-input { flex-grow: 1; padding: 15px; font-size: 16px; border: 1px solid #ccc; border-radius: 12px; }
        #ai-generate-learn-btn { background: linear-gradient(45deg, var(--accent-color), var(--primary-color)); }
        .learn-card { background-color: var(--card-bg-color); border-radius: var(--border-radius); box-shadow: 0 6px 15px rgba(0,0,0,0.08); padding: 15px; margin-bottom: 25px; }
        .learn-card-title { margin: 0 0 15px 0; font-size: 20px; color: var(--secondary-color); }
        .video-scroller-card { margin-left: -15px; margin-right: -15px; }
        .video-container { position: relative; width: 100%; padding-top: 56.25%; border-radius: 12px; overflow: hidden; background-color: #000; }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }
        .article-container { line-height: 1.7; color: var(--text-color); }
        .article-container h4 { margin-top: 0; color: var(--primary-color); }
        .article-container p { font-size: 15px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); z-index: 2000; display: none; align-items: flex-end; justify-content: center; }
        .modal-content { background: var(--background-color); width: 100%; max-height: 90vh; border-top-left-radius: 20px; border-top-right-radius: 20px; box-shadow: 0 -5px 20px rgba(0,0,0,0.2); animation: slideInUp 0.4s ease-out; display: flex; flex-direction: column; }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { margin: 0; font-size: 20px; color: var(--secondary-color); }
        .modal-close { font-size: 28px; cursor: pointer; color: var(--text-light-color); }
        .modal-body { padding: 20px; overflow-y: auto; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-color); }
        .form-group input, .form-group select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ccc; font-size: 16px; font-family: var(--font-family); box-sizing: border-box; }
        .form-group .multi-select-container { display: flex; flex-wrap: wrap; gap: 10px; }
        .multi-select-option { padding: 8px 15px; background: #e0e0e0; border-radius: 20px; cursor: pointer; }
        .multi-select-option.selected { background: var(--primary-color); color: white; }
        .modal-footer { padding: 20px; border-top: 1px solid #ddd; background: white; }
        #generate-diet-plan-btn { width: 100%; background: linear-gradient(45deg, var(--accent-color), var(--primary-color)); }
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background-color: var(--card-bg-color); display: flex; justify-content: space-around; align-items: center; height: 65px; box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.07); z-index: 1000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; color: var(--text-light-color); transition: color 0.3s; flex-grow: 1; text-align: center; }
        .nav-item i { font-size: 24px; }
        .nav-item span { font-size: 12px; margin-top: 4px; }
        .nav-item.active { color: var(--primary-color); }
        /* --- नए स्टाइल --- */
        #disease-list { list-style: none; padding: 0; margin: 0; }
        #disease-list li { background-color: var(--card-bg-color); padding: 18px; margin-bottom: 10px; border-radius: 12px; font-weight: 500; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        #disease-list li:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        #disease-details-container { display: flex; flex-direction: column; gap: 20px; }
        .page-header { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
        #back-to-list-btn { background: none; border: none; font-size: 32px; color: var(--primary-color); cursor: pointer; padding: 0; }
        .page-header h2 { margin: 0; font-size: 24px; color: var(--secondary-color); }
        .disease-card { background-color: var(--card-bg-color); border-radius: var(--border-radius); padding: 20px; box-shadow: var(--box-shadow-3d); border-top: 10px solid; aspect-ratio: 16 / 9; overflow-y: auto; }
        .disease-card h3 { margin-top: 0; font-size: 20px; }
        .disease-card ul { list-style-position: inside; padding-left: 5px; }
        .disease-card p { line-height: 1.6; }
        /* --- स्कैनर और न्यूट्रिशन Modal के लिए स्टाइल --- */
        #scanner-modal { align-items: center; justify-content: center; }
        #scanner-modal .modal-content { max-height: 80vh; height: 80vh; }
        #barcode-scanner-view { width: 100%; height: 100%; object-fit: cover; }
        #barcode-scanner-view video { width: 100%; height: 100%; }
        #scan-barcode-btn { margin-top: 20px; background: linear-gradient(45deg, #FF9500, #FF5E3A); width: 100%; }
    </style>
</head>
<body>

    <div class="main-container">
        
        <div id="home" class="screen active">
            <div class="input-container">
                <input type="text" id="medicine-input" placeholder="दवा का नाम टाइप करें...">
                <button id="add-med-btn" class="btn-3d">Add</button>
            </div>
            <div id="medicine-tags-container"></div>
            <button id="generate-btn" class="btn-3d">AI Generate</button>
            <div id="results-container" style="display: none;"></div>
        </div>

        <div id="diet-plans" class="screen">
            <div class="input-container">
                <input type="text" id="disease-input" placeholder="बीमारी का नाम टाइप करें...">
                <button id="add-disease-btn" class="btn-3d">Add</button>
            </div>
            <ul id="disease-list"></ul>
        </div>

        <div id="disease-details" class="screen">
            <div class="page-header">
                <button id="back-to-list-btn"><i class='bx bx-arrow-back'></i></button>
                <h2 id="disease-title"></h2>
            </div>
            <div id="disease-details-container"></div>
        </div>
        
        <div id="my-plan" class="screen">
            <div id="my-plan-empty-state">
                <i class='bx bxs-dish'></i>
                <h2>आपके लिए एक ख़ास भोजन योजना बनाएँ</h2>
                <p>बस कुछ सवालों के जवाब दें और हमारा AI आपकी दवाओं, स्वास्थ्य लक्ष्यों और स्वाद के अनुसार एक व्यक्तिगत मील प्लान तैयार करेगा।</p>
                <button id="create-my-plan-btn" class="btn-3d">मेरा प्लान बनाएँ</button>
            </div>
            <div id="my-plan-generated-state">
                <div class="nutrition-summary"></div>
                <button id="scan-barcode-btn" class="btn-3d"><i class='bx bx-barcode-reader'></i> भोजन स्कैन करें</button>
            </div>
        </div>

        <div id="alerts" class="screen">
            <div class="date-navigator">
                <i id="prev-day-btn" class='bx bx-chevron-left'></i>
                <h2 id="current-date-display"></h2>
                <span id="today-btn">Today</span>
                <i id="next-day-btn" class='bx bx-chevron-right'></i>
            </div>
            <div id="timeline-view" class="timeline-container"></div>
            <div id="alert-empty-state" style="display: none;">
                <i class='bx bx-calendar-check'></i>
                <h2>कोई अलर्ट नहीं</h2>
                <p>आज के लिए कोई अलर्ट शेड्यूल नहीं है। 'My Plan' पर जाकर अपना डाइट प्लान बनाएँ।</p>
            </div>
        </div>

        <div id="learn" class="screen">
            <div class="learn-search-container">
                <input type="text" id="learn-search-input" placeholder="जैसे: Push-ups, Yoga...">
                <button id="ai-generate-learn-btn" class="btn-3d">AI Generate</button>
            </div>
            <div class="learn-card">
                <h3 class="learn-card-title">वीडियो देखें</h3>
                <div class="video-scroller-card">
                    <div id="video-scroller-container" class="results-scroller"></div>
                </div>
            </div>
            <div class="learn-card">
                <h3 class="learn-card-title">AI द्वारा तैयार आर्टिकल</h3>
                <div id="ai-article-container" class="article-container">
                    <p>ऊपर किसी विषय को खोजें और AI से उसके बारे में जानकारी पाएँ।</p>
                </div>
            </div>
        </div>

    </div>

    <!-- Questionnaire Modal (मौजूदा) -->
    <div id="questionnaire-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>मेरा प्लान बनाएँ</h2>
                <span class="modal-close" id="modal-close-btn">&times;</span>
            </div>
            <div class="modal-body">
                <form id="diet-questionnaire-form">
                    <div class="form-group"><label for="age">उम्र (वर्षों में)</label><select id="age" name="age"></select></div>
                    <div class="form-group"><label for="gender">लिंग</label><select id="gender" name="gender"><option value="male">पुरुष</option><option value="female">महिला</option><option value="other">अन्य</option></select></div>
                    <div class="form-group"><label for="height">कद (cm)</label><select id="height" name="height"></select></div>
                    <div class="form-group"><label for="weight">वजन (kg)</label><select id="weight" name="weight"></select></div>
                    <div class="form-group"><label>दैनिक गतिविधि स्तर</label><select name="activity_level"><option value="sedentary">गतिहीन</option><option value="lightly_active">थोड़ा सक्रिय</option><option value="moderately_active">मध्यम रूप से सक्रिय</option><option value="very_active">बहुत सक्रिय</option></select></div>
                    <div class="form-group"><label>कोई ज्ञात स्वास्थ्य स्थितियाँ?</label><div class="multi-select-container"><div class="multi-select-option" data-value="none">कोई नहीं</div><div class="multi-select-option" data-value="diabetes">डायबिटीज</div><div class="multi-select-option" data-value="hypertension">उच्च रक्तचाप</div><div class="multi-select-option" data-value="thyroid">थायराइड</div><div class="multi-select-option" data-value="pcos">PCOS</div></div></div>
                    <div class="form-group"><label>कोई खाद्य एलर्जी?</label><div class="multi-select-container"><div class="multi-select-option" data-value="gluten">ग्लूटेन</div><div class="multi-select-option" data-value="dairy">डेयरी</div><div class="multi-select-option" data-value="nuts">नट्स</div><div class="multi-select-option" data-value="seafood">समुद्री भोजन</div></div></div>
                    <div class="form-group"><label>प्राथमिक आहार वरीयता</label><select name="diet_preference"><option value="vegetarian">शाकाहारी</option><option value="non_vegetarian">मांसाहारी</option><option value="vegan">वेगन</option><option value="jain">जैन</option></select></div>
                    <div class="form-group"><label>प्राथमिक लक्ष्य</label><select name="primary_goal"><option value="weight_loss">वजन घटाना</option><option value="muscle_gain">मांसपेशी बढ़ाना</option><option value="maintenance">रखरखाव</option><option value="improve_immunity">प्रतिरक्षा में सुधार</option></select></div>
                </form>
            </div>
            <div class="modal-footer"><button id="generate-diet-plan-btn" class="btn-3d">डाइट प्लान जेनरेट करें</button></div>
        </div>
    </div>

    <!-- Nutrition Details Modal (नया) -->
    <div id="nutrition-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>पोषक तत्व</h2>
                <span class="modal-close" id="nutrition-modal-close-btn">&times;</span>
            </div>
            <div id="nutrition-modal-body" class="modal-body">
                <!-- पोषक तत्वों की जानकारी यहाँ दिखाई जाएगी -->
            </div>
        </div>
    </div>

    <!-- Barcode Scanner Modal (नया) -->
    <div id="scanner-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>बारकोड स्कैन करें</h2>
                <span class="modal-close" id="scanner-modal-close-btn">&times;</span>
            </div>
            <div class="modal-body">
                <div id="barcode-scanner-view"></div>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" data-screen="home"> <i class='bx bxs-home-alt-2'></i> <span>Home</span> </div>
        <div class="nav-item" data-screen="diet-plans"> <i class='bx bxs-food-menu'></i> <span>Diet Plans</span> </div>
        <div class="nav-item" data-screen="my-plan"> <i class='bx bxs-dish'></i> <span>My Plan</span> </div>
        <div class="nav-item" data-screen="alerts"> <i class='bx bxs-bell-ring'></i> <span>Alerts</span> </div>
        <div class="nav-item" data-screen="learn"> <i class='bx bxs-book-heart'></i> <span>Learn</span> </div>
    </nav>
    
    <!-- QuaggaJS Library for Barcode Scanning (नया) -->
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyC7ojmyQMg2ljB7kT4MQSmIhz43QNHpE0w",
            authDomain: "shubhmed-9f05d.firebaseapp.com",
            projectId: "shubhmed-9f05d",
            storageBucket: "shubhmed-9f05d.firebasestorage.app",
            messagingSenderId: "42179676197",
            appId: "1:42179676197:web:1796559543fb869c5297cc",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        const db = getFirestore(app);
        let currentUser = null;

        // --- AUTHENTICATION & DATA FETCHING (मौजूदा) ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const plan = await getUserDietPlan();
                if (plan) {
                    renderMyPlanUI(plan);
                    document.getElementById('my-plan-empty-state').style.display = 'none';
                    document.getElementById('my-plan-generated-state').style.display = 'block';
                }
                renderAlerts();
            } else {
                signInAnonymously(auth).catch(console.error);
            }
        });
        async function saveUserDietPlan(plan) {
            if (!currentUser) return;
            const userDocRef = doc(db, "users", currentUser.uid);
            await setDoc(userDocRef, { dietPlan: plan }, { merge: true });
        }
        async function getUserDietPlan() {
            if (!currentUser) return null;
            const userDocRef = doc(db, "users", currentUser.uid);
            const userDoc = await getDoc(userDocRef);
            return userDoc.exists() ? userDoc.data().dietPlan : null;
        }

        // --- DOMContentLoaded: MAIN APP LOGIC (मौजूदा) ---
        document.addEventListener('DOMContentLoaded', function() {
            // --- Navigation (मौजूदा) ---
            const navItems = document.querySelectorAll('.nav-item');
            const screens = document.querySelectorAll('.screen');
            function showScreen(screenId) {
                screens.forEach(s => s.classList.remove('active'));
                document.getElementById(screenId)?.classList.add('active');
                navItems.forEach(item => item.classList.toggle('active', item.dataset.screen === screenId));
                if (screenId === 'alerts') renderAlerts();
            }
            navItems.forEach(item => item.addEventListener('click', () => showScreen(item.dataset.screen)));
            
            // --- Home Screen Logic (मौजूदा) ---
            const medicineInput = document.getElementById('medicine-input');
            const addMedBtn = document.getElementById('add-med-btn');
            const tagsContainer = document.getElementById('medicine-tags-container');
            const generateBtn = document.getElementById('generate-btn');
            const resultsContainer = document.getElementById('results-container');
            addMedBtn.addEventListener('click', () => {
                const medName = medicineInput.value.trim();
                if (medName) {
                    const tag = document.createElement('div');
                    tag.classList.add('medicine-tag');
                    tag.innerHTML = `<span>${medName}</span><span class="remove-tag">&times;</span>`;
                    tagsContainer.appendChild(tag);
                    medicineInput.value = '';
                    tag.querySelector('.remove-tag').addEventListener('click', () => tag.remove());
                }
            });
            generateBtn.addEventListener('click', async () => {
                if (tagsContainer.children.length === 0) return alert("कृपया कम से कम एक दवा जोड़ें।");
                if (!currentUser) return alert("AI फीचर का उपयोग करने के लिए कृपया लॉग इन करें।");
                generateBtn.disabled = true;
                generateBtn.textContent = 'Generating...';
                try {
                    const medicineNames = Array.from(tagsContainer.children).map(tag => tag.querySelector('span').textContent).join(', ');
                    const idToken = await currentUser.getIdToken();
                    const response = await fetch('/get-food-interaction', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ medicines: medicineNames, token: idToken })
                    });
                    if (!response.ok) throw new Error((await response.json()).error || 'Failed to get response from AI.');
                    const result = await response.json();
                    const aiJsonText = result.answer.replace(/```json/g, '').replace(/```/g, '').trim();
                    const data = JSON.parse(aiJsonText);
                    const createList = (items, type) => {
                        if (!items || items.length === 0) return '<ul><li>कोई विशेष जानकारी नहीं।</li></ul>';
                        let listHtml = '<ul>';
                        if (type === 'safe') {
                            listHtml += items.map(item => `<li>${item}</li>`).join('');
                        } else {
                            listHtml += items.map(item => `<li><strong>${item.item}:</strong> ${item.reason}</li>`).join('');
                        }
                        listHtml += '</ul>';
                        return listHtml;
                    };
                    resultsContainer.innerHTML = `
                        <p class="swipe-indicator"><i class='bx bx-left-arrow-alt'></i> स्वाइप करके देखें <i class='bx bx-right-arrow-alt'></i></p>
                        <div class="results-scroller">
                            <div class="result-card card-avoid"> <div class="result-card-header"> <span class="sticker">🍔</span> <h3>पूरी तरह से बचें</h3> </div> <div class="result-card-content"> ${createList(data.avoid, 'avoid')} </div> </div>
                            <div class="result-card card-limit"> <div class="result-card-header"> <span class="sticker">🍚</span> <h3>सीमित मात्रा में लें</h3> </div> <div class="result-card-content"> ${createList(data.limit, 'limit')} </div> </div>
                            <div class="result-card card-safe"> <div class="result-card-header"> <span class="sticker">🥗</span> <h3>सुरक्षित भोजन</h3> </div> <div class="result-card-content"> ${createList(data.safe, 'safe')} </div> </div>
                        </div>`;
                    resultsContainer.style.display = 'block';
                } catch (error) {
                    console.error("Error generating medicine interaction:", error);
                    alert("Error: " + error.message);
                } finally {
                    generateBtn.disabled = false;
                    generateBtn.textContent = 'AI Generate';
                }
            });

            // --- Diet Plans & Disease Details Logic (मौजूदा) ---
            const diseaseInput = document.getElementById('disease-input');
            const addDiseaseBtn = document.getElementById('add-disease-btn');
            const diseaseList = document.getElementById('disease-list');
            const diseaseDetailsContainer = document.getElementById('disease-details-container');
            const diseaseTitle = document.getElementById('disease-title');
            const backToListBtn = document.getElementById('back-to-list-btn');
            let commonDiseases = ["डायबिटीज (Diabetes)", "उच्च रक्तचाप (Hypertension)", "थायराइड (Thyroid)", "कोलेस्ट्रॉल (Cholesterol)", "मोटापा (Obesity)", "किडनी स्टोन (Kidney Stone)", "फैटी लिवर (Fatty Liver)", "अस्थमा (Asthma)", "गठिया (Arthritis)", "एनीमिया (Anemia)", "पीलिया (Jaundice)", "माइग्रेन (Migraine)", "कब्ज (Constipation)", "एसिडिटी (Acidity)", "डेंगू (Dengue)", "चिकनगुनिया (Chikungunya)", "वायरल बुखार (Viral Fever)", "डिप्रेशन (Depression)", "त्वचा की एलर्जी (Skin Allergy)", "बालों का झड़ना (Hair Fall)"];
            function renderDiseaseList() {
                diseaseList.innerHTML = '';
                commonDiseases.forEach(disease => {
                    const li = document.createElement('li');
                    li.textContent = disease;
                    li.dataset.disease = disease;
                    diseaseList.appendChild(li);
                });
            }
            addDiseaseBtn.addEventListener('click', () => {
                const newDisease = diseaseInput.value.trim();
                if (newDisease && !commonDiseases.includes(newDisease)) {
                    commonDiseases.unshift(newDisease);
                    renderDiseaseList();
                    diseaseInput.value = '';
                }
            });
            diseaseList.addEventListener('click', (e) => {
                if (e.target.tagName === 'LI') {
                    const diseaseName = e.target.dataset.disease;
                    fetchAndDisplayDiseaseInfo(diseaseName);
                }
            });
            backToListBtn.addEventListener('click', () => showScreen('diet-plans'));
            async function fetchAndDisplayDiseaseInfo(diseaseName) {
                if (!currentUser) return alert("AI फीचर का उपयोग करने के लिए कृपया लॉग इन करें।");
                diseaseTitle.textContent = diseaseName;
                diseaseDetailsContainer.innerHTML = '<p>AI आपके लिए जानकारी तैयार कर रहा है...</p>';
                showScreen('disease-details');
                try {
                    const idToken = await currentUser.getIdToken();
                    const prompt = `Provide a detailed diet and management plan in simple Hindi for the disease: "${diseaseName}". The response must be a valid JSON object ONLY, with no extra text or markdown. The JSON should have four keys: "avoid", "limit", "safe", and "cure". 1. "avoid": An array of at least 5 strings listing foods to completely avoid. 2. "limit": An array of at least 5 strings listing foods to eat in moderation. 3. "safe": An array of at least 5 strings listing beneficial foods. 4. "cure": A short paragraph in Hindi (as a single string) explaining general tips to manage or cure the disease.`;
                    const response = await fetch('/ask-ai', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ question: prompt, token: idToken })
                    });
                    if (!response.ok) throw new Error((await response.json()).error || 'Failed to get response from AI.');
                    const result = await response.json();
                    const aiJsonText = result.answer.replace(/```json/g, '').replace(/```/g, '').trim();
                    const data = JSON.parse(aiJsonText);
                    diseaseDetailsContainer.innerHTML = `
                        <div class="disease-card card-avoid"><h3>क्या न खाएं 🍔</h3><ul>${data.avoid.map(item => `<li>${item}</li>`).join('')}</ul></div>
                        <div class="disease-card card-limit"><h3>क्या कम खाएं 🍚</h3><ul>${data.limit.map(item => `<li>${item}</li>`).join('')}</ul></div>
                        <div class="disease-card card-safe"><h3>क्या खाएं 🥗</h3><ul>${data.safe.map(item => `<li>${item}</li>`).join('')}</ul></div>
                        <div class="disease-card card-cure"><h3>इलाज और प्रबंधन 💡</h3><p>${data.cure}</p></div>
                    `;
                } catch (error) {
                    console.error("Error fetching disease info:", error);
                    diseaseDetailsContainer.innerHTML = `<p>जानकारी प्राप्त करने में विफल। कृपया पुनः प्रयास करें। Error: ${error.message}</p>`;
                }
            }
            renderDiseaseList();

            // --- My Plan Logic (मौजूदा) ---
            const createMyPlanBtn = document.getElementById('create-my-plan-btn');
            const questionnaireModal = document.getElementById('questionnaire-modal');
            const closeModalBtn = document.getElementById('modal-close-btn');
            const generateDietPlanBtn = document.getElementById('generate-diet-plan-btn');
            createMyPlanBtn.addEventListener('click', () => { questionnaireModal.style.display = 'flex'; });
            closeModalBtn.addEventListener('click', () => { questionnaireModal.style.display = 'none'; });
            generateDietPlanBtn.addEventListener('click', async () => {
                if (!currentUser) return alert("Authentication error. Please refresh the page.");
                generateDietPlanBtn.disabled = true;
                generateDietPlanBtn.textContent = 'Generating...';
                try {
                    const formData = new FormData(document.getElementById('diet-questionnaire-form'));
                    const userDetails = Object.fromEntries(formData.entries());
                    userDetails.health_conditions = Array.from(document.querySelectorAll('#diet-questionnaire-form .multi-select-option.selected')).map(el => el.dataset.value).filter(val => ['diabetes', 'hypertension', 'thyroid', 'pcos'].includes(val));
                    userDetails.allergies = Array.from(document.querySelectorAll('#diet-questionnaire-form .multi-select-option.selected')).map(el => el.dataset.value).filter(val => ['gluten', 'dairy', 'nuts', 'seafood'].includes(val));
                    const prompt = `Create a structured 7-day diet plan in Hindi for a user with these details: - Age: ${userDetails.age}, Gender: ${userDetails.gender}, Height: ${userDetails.height}cm, Weight: ${userDetails.weight}kg, Activity: ${userDetails.activity_level}, Goal: ${userDetails.primary_goal} - Conditions: ${userDetails.health_conditions.join(', ') || 'None'}, Allergies: ${userDetails.allergies.join(', ') || 'None'}, Diet: ${userDetails.diet_preference}. The output MUST be a valid JSON object ONLY. No extra text or markdown. The root object must have two keys: "metadata" and "weeklyPlan". 1. "metadata": An object with total "calories", "protein", "carbs", "fat" as numbers. 2. "weeklyPlan": An array of 7 objects, one for each day from Sunday (index 0) to Saturday (index 6). Each day object must have "day" and "schedule". The "schedule" must be an array of meal objects. Each meal object needs: "time", "icon", "title", "instruction", and "type" ("meal"). Provide at least 4 meals per day: Breakfast, Lunch, Evening Snack, and Dinner.`;
                    const idToken = await currentUser.getIdToken();
                    const response = await fetch('/generate-diet-plan', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ prompt, token: idToken }) });
                    if (!response.ok) throw new Error((await response.json()).error || 'Failed to generate plan.');
                    const result = await response.json();
                    const planText = result.answer.replace(/```json/g, '').replace(/```/g, '').trim();
                    const newPlan = JSON.parse(planText);
                    await saveUserDietPlan(newPlan);
                    renderMyPlanUI(newPlan);
                    questionnaireModal.style.display = 'none';
                    document.getElementById('my-plan-empty-state').style.display = 'none';
                    document.getElementById('my-plan-generated-state').style.display = 'block';
                    await renderAlerts();
                    showScreen('alerts');
                } catch (error) {
                    console.error("Error generating diet plan:", error);
                    alert("Error: " + error.message);
                } finally {
                    generateDietPlanBtn.disabled = false;
                    generateDietPlanBtn.textContent = 'डाइट प्लान जेनरेट करें';
                }
            });
            function renderMyPlanUI(plan) {
                 if(!plan || !plan.metadata) return;
                 const nutritionContainer = document.querySelector('#my-plan-generated-state .nutrition-summary');
                 nutritionContainer.innerHTML = `...`; // जैसा पहले था
            }

            // --- Alerts Screen Logic (थोड़ा बदला हुआ) ---
            const prevDayBtn = document.getElementById('prev-day-btn');
            const nextDayBtn = document.getElementById('next-day-btn');
            const todayBtn = document.getElementById('today-btn');
            const currentDateDisplay = document.getElementById('current-date-display');
            const timelineView = document.getElementById('timeline-view');
            const alertEmptyState = document.getElementById('alert-empty-state');
            let currentAlertDate = new Date();
            async function renderAlerts() {
                if (!currentDateDisplay || !timelineView || !alertEmptyState) return;
                currentDateDisplay.textContent = formatAlertDate(currentAlertDate);
                timelineView.innerHTML = '';
                const plan = await getUserDietPlan();
                if (!plan || !plan.weeklyPlan || plan.weeklyPlan.length < 7) {
                    alertEmptyState.style.display = 'block';
                    timelineView.style.display = 'none';
                } else {
                    alertEmptyState.style.display = 'none';
                    timelineView.style.display = 'block';
                    const dayOfWeek = currentAlertDate.getDay();
                    const todaySchedule = plan.weeklyPlan[dayOfWeek].schedule;
                    if (!todaySchedule || todaySchedule.length === 0) {
                         alertEmptyState.style.display = 'block';
                         timelineView.style.display = 'none';
                         return;
                    }
                    todaySchedule.forEach((alert) => {
                        const card = document.createElement('div');
                        card.className = `alert-card`;
                        card.innerHTML = `<div class="alert-time">${alert.time}</div><div class="alert-timeline-marker"><div class="alert-icon">${alert.icon}</div></div><div class="alert-content"><h3>${alert.title}</h3><p>${alert.instruction}</p></div>`;
                        timelineView.appendChild(card);
                        
                        // --- नया बदलाव: भोजन पर क्लिक करके पोषक तत्व देखें ---
                        const alertContent = card.querySelector('.alert-content');
                        alertContent.addEventListener('click', () => {
                            fetchAndShowNutrition(alert.instruction);
                        });
                    });
                }
            }
            function formatAlertDate(date) { /* जैसा पहले था */ }
            prevDayBtn.addEventListener('click', () => { currentAlertDate.setDate(currentAlertDate.getDate() - 1); renderAlerts(); });
            nextDayBtn.addEventListener('click', () => { currentAlertDate.setDate(currentAlertDate.getDate() + 1); renderAlerts(); });
            todayBtn.addEventListener('click', () => { currentAlertDate = new Date(); renderAlerts(); });
            
            // --- Learn Screen Logic (मौजूदा) ---
            // ... जैसा पहले था ...

            // --- Nutrition & Scanner Logic (नया) ---
            const nutritionModal = document.getElementById('nutrition-modal');
            const nutritionModalCloseBtn = document.getElementById('nutrition-modal-close-btn');
            const nutritionModalBody = document.getElementById('nutrition-modal-body');
            const scannerModal = document.getElementById('scanner-modal');
            const scannerModalCloseBtn = document.getElementById('scanner-modal-close-btn');
            const scanBarcodeBtn = document.getElementById('scan-barcode-btn');
            const barcodeScannerView = document.getElementById('barcode-scanner-view');

            nutritionModalCloseBtn.addEventListener('click', () => nutritionModal.style.display = 'none');
            scannerModalCloseBtn.addEventListener('click', stopScanner);
            scanBarcodeBtn.addEventListener('click', startScanner);

            async function fetchAndShowNutrition(foodQuery) {
                nutritionModalBody.innerHTML = '<p>पोषक तत्व लोड हो रहे हैं...</p>';
                nutritionModal.style.display = 'flex';
                try {
                    const response = await fetch(`/get-nutrition-info?food=${encodeURIComponent(foodQuery)}`);
                    if (!response.ok) throw new Error('Nutritionix/USDA API से जानकारी नहीं मिली।');
                    const result = await response.json();
                    
                    const foodData = result.data;
                    let html = `<h4>${foodData.food_name || foodQuery}</h4>`;
                    html += '<ul>';
                    html += `<li>कैलोरी: ${foodData.nf_calories || 'N/A'} kcal</li>`;
                    html += `<li>प्रोटीन: ${foodData.nf_protein || 'N/A'} g</li>`;
                    html += `<li>कार्ब्स: ${foodData.nf_total_carbohydrate || 'N/A'} g</li>`;
                    html += `<li>शुगर: ${foodData.nf_sugars || 'N/A'} g</li>`;
                    html += `<li>फैट: ${foodData.nf_total_fat || 'N/A'} g</li>`;
                    html += `<li>सोडियम: ${foodData.nf_sodium || 'N/A'} mg</li>`;
                    html += '</ul>';
                    nutritionModalBody.innerHTML = html;

                } catch (error) {
                    nutritionModalBody.innerHTML = `<p>${error.message}</p>`;
                }
            }

            function startScanner() {
                scannerModal.style.display = 'flex';
                Quagga.init({
                    inputStream: {
                        name: "Live",
                        type: "LiveStream",
                        target: barcodeScannerView,
                        constraints: {
                            width: 480,
                            height: 320,
                            facingMode: "environment" // rear camera
                        },
                    },
                    decoder: {
                        readers: ["ean_reader", "upc_reader", "code_128_reader"]
                    }
                }, function(err) {
                    if (err) {
                        console.log(err);
                        return;
                    }
                    Quagga.start();
                });

                Quagga.onDetected(handleBarcodeDetection);
            }

            function stopScanner() {
                Quagga.offDetected(handleBarcodeDetection);
                Quagga.stop();
                scannerModal.style.display = 'none';
            }

            function handleBarcodeDetection(result) {
                const code = result.codeResult.code;
                alert(`बारकोड मिला: ${code}\n\n(यह फीचर डेमो है। सर्वर पर UPC लुकअप फंक्शन जोड़ना होगा)`);
                // यहाँ आप सर्वर को बारकोड भेजकर जानकारी प्राप्त कर सकते हैं।
                // fetchAndShowNutritionByBarcode(code); 
                stopScanner();
            }

            // --- Form Population & Initial Setup (मौजूदा) ---
            function populateSelect(elementId, start, end) { /* जैसा पहले था */ }
            populateSelect('age', 1, 100); populateSelect('height', 100, 220); populateSelect('weight', 20, 200);
            document.querySelectorAll('.multi-select-option').forEach(option => {
                option.addEventListener('click', () => { option.classList.toggle('selected'); });
            });
            showScreen('home');
        });
    </script>
</body>
</html>
